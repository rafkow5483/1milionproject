//+------------------------------------------------------------------+
//| SWIECA_BUY_FINAL_PRO_SPREAD.mq5                                   |
//| TP zapamiÄ™tane + retry close + spread filter on ENTRY            |
//+------------------------------------------------------------------+
#property strict

#include <Trade/Trade.mqh>
CTrade trade;

// ================= INPUTY =================
input double Lots          = 0.1;
input int    TP_Pips       = 50;
input int    SL_Pips       = 50;
input int    MaxSpreadPips = 6;   // ðŸ”¥ FILTR SPREADU (TYLKO WEJÅšCIE)

// ================= ZMIENNE =================
datetime lastBar = 0;

double rememberedBearHigh = 0.0;
bool   haveBearHigh = false;

bool   tpHit = false;
int    closeAttempts = 0;

//+------------------------------------------------------------------+
//| PIP                                                              |
//+------------------------------------------------------------------+
double Pip()
{
   if(_Digits == 3 || _Digits == 5)
      return _Point * 10;
   return _Point;
}

//+------------------------------------------------------------------+
//| ON TICK                                                          |
//+------------------------------------------------------------------+
void OnTick()
{
   double pip = Pip();

   // ================================================================
   // 1ï¸âƒ£ ZARZÄ„DZANIE OTWARTÄ„ POZYCJÄ„ (TP / SL + RETRY)
   // ================================================================
   if(PositionSelect(_Symbol))
   {
      double bid       = SymbolInfoDouble(_Symbol, SYMBOL_BID);
      double openPrice = PositionGetDouble(POSITION_PRICE_OPEN);

      double profitPips = (bid - openPrice) / pip;

      // zapamiÄ™taj TP
      if(profitPips >= TP_Pips)
         tpHit = true;

      // ===== TAKE PROFIT =====
      if(tpHit)
      {
         if(trade.PositionClose(_Symbol))
         {
            Print("TP closed after attempts: ", closeAttempts);
            tpHit = false;
            closeAttempts = 0;
            return;
         }
         else
         {
            closeAttempts++;
            Print("TP close rejected (", closeAttempts, "): ",
                  trade.ResultRetcodeDescription());
            return;
         }
      }

      // ===== STOP LOSS =====
      if(profitPips <= -SL_Pips)
      {
         if(trade.PositionClose(_Symbol))
         {
            Print("SL closed after attempts: ", closeAttempts);
            tpHit = false;
            closeAttempts = 0;
            return;
         }
         else
         {
            closeAttempts++;
            Print("SL close rejected (", closeAttempts, "): ",
                  trade.ResultRetcodeDescription());
            return;
         }
      }
   }

   // ================================================================
   // 2ï¸âƒ£ LOGIKA WEJÅšCIA â€“ TYLKO NA NOWEJ ÅšWIECY
   // ================================================================
   datetime barTime = iTime(_Symbol, _Period, 0);
   if(barTime == lastBar) return;
   lastBar = barTime;

   // tylko jedna pozycja
   if(PositionsTotal() > 0) return;

   // ===== FILTR SPREADU (TYLKO OTWARCIE) =====
   double spreadPips = (SymbolInfoDouble(_Symbol, SYMBOL_ASK)
                       - SymbolInfoDouble(_Symbol, SYMBOL_BID)) / pip;

   if(spreadPips > MaxSpreadPips)
   {
      Print("ENTRY BLOCKED - spread too high: ", spreadPips);
      return;
   }

   // ostatnia zamkniÄ™ta Å›wieca
   double open1  = iOpen(_Symbol, _Period, 1);
   double close1 = iClose(_Symbol, _Period, 1);
   double high1  = iHigh(_Symbol, _Period, 1);

   // Å›wieca spadkowa â†’ zapamiÄ™taj HIGH
   if(close1 < open1)
   {
      rememberedBearHigh = high1;
      haveBearHigh = true;
      return;
   }

   // wybicie HIGH â†’ BUY
   if(haveBearHigh && close1 > rememberedBearHigh)
   {
      double price = SymbolInfoDouble(_Symbol, SYMBOL_ASK);

      if(trade.Buy(Lots, _Symbol, price, 0, 0, "Break Bear High"))
      {
         Print("BUY opened at ", price, " | spread: ", spreadPips);
         tpHit = false;
         closeAttempts = 0;
      }

      haveBearHigh = false;
      rememberedBearHigh = 0.0;
   }
}


