
//+------------------------------------------------------------------+
//| SWIECA_BUY_LIVE_BREAK_OR_CLOSE.mq5                                |
//| BUY only | Entry on BREAK or CLOSE (whichever first)             |
//+------------------------------------------------------------------+
#property strict

#include <Trade/Trade.mqh>
CTrade trade;

// ================= INPUTY =================
input double Lots            = 0.1;
input int    TP_Pips         = 50;
input int    SL_Pips         = 500;
input int    MaxSpreadPips   = 10;
input int    BreakBufferPips = 50;

// ================= ZMIENNE =================
datetime lastBar = 0;

double rememberedBearHigh = 0.0;
bool   haveBearHigh = false;

bool   tpHit = false;
int    closeAttempts = 0;

//+------------------------------------------------------------------+
//| PIP                                                              |
//+------------------------------------------------------------------+
double Pip()
{
   if(_Digits == 3 || _Digits == 5)
      return _Point * 10;
   return _Point;
}

//+------------------------------------------------------------------+
//| ON TICK                                                          |
//+------------------------------------------------------------------+
void OnTick()
{
   double pip = Pip();

   // ================================================================
   // 1️⃣ ZARZĄDZANIE OTWARTĄ POZYCJĄ (TP / SL + RETRY)
   // ================================================================
   if(PositionSelect(_Symbol))
   {
      double bid       = SymbolInfoDouble(_Symbol, SYMBOL_BID);
      double openPrice = PositionGetDouble(POSITION_PRICE_OPEN);

      double profitPips = (bid - openPrice) / pip;

      if(profitPips >= TP_Pips)
         tpHit = true;

      if(tpHit)
      {
         if(trade.PositionClose(_Symbol))
         {
            tpHit = false;
            closeAttempts = 0;
         }
         return;
      }

      if(profitPips <= -SL_Pips)
      {
         trade.PositionClose(_Symbol);
         tpHit = false;
         closeAttempts = 0;
         return;
      }

      return; // nie szukaj nowego wejścia
   }

   // ================================================================
   // 2️⃣ FILTR SPREADU (TYLKO OTWARCIE)
   // ================================================================
   double spreadPips = (SymbolInfoDouble(_Symbol, SYMBOL_ASK)
                       - SymbolInfoDouble(_Symbol, SYMBOL_BID)) / pip;

   if(spreadPips > MaxSpreadPips)
      return;

   // ================================================================
   // 3️⃣ OBSŁUGA NOWEJ ŚWIECY – ZAPAMIĘTAJ HIGH
   // ================================================================
   datetime barTime = iTime(_Symbol, _Period, 0);
   bool newBar = false;

   if(barTime != lastBar)
   {
      lastBar = barTime;
      newBar = true;

      double open1  = iOpen(_Symbol, _Period, 1);
      double close1 = iClose(_Symbol, _Period, 1);
      double high1  = iHigh(_Symbol, _Period, 1);

      if(close1 < open1)
      {
         rememberedBearHigh = high1;
         haveBearHigh = true;
      }
   }

   if(!haveBearHigh)
      return;

   // ================================================================
   // 4️⃣ WEJŚCIE BUY – CO PIERWSZE: BREAK LUB CLOSE
   // ================================================================
   double ask = SymbolInfoDouble(_Symbol, SYMBOL_ASK);

   bool breakSignal = ask > rememberedBearHigh + BreakBufferPips * pip;
   bool closeSignal = false;

   if(newBar)
   {
      double close1 = iClose(_Symbol, _Period, 1);
      if(close1 > rememberedBearHigh)
         closeSignal = true;
   }

   if(breakSignal || closeSignal)
   {
      if(trade.Buy(Lots, _Symbol, ask, 0, 0, "BUY break OR close"))
      {
         tpHit = false;
         closeAttempts = 0;
      }

      haveBearHigh = false;
      rememberedBearHigh = 0.0;
   }
}

